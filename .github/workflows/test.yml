name: CI

on: [push,pull_request]

jobs:
  check:
    name: deno format & lint check
    uses: kakomimasu/kakomimasu.github.io/.github/workflows/dfl-check.yml@main
  test:
    needs: check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Firebase Emulator
        shell: bash -xe {0}
        run: |
          curl -sL https://firebase.tools | upgrade=true bash
          firebase setup:emulators:database
          firebase setup:emulators:firestore
      - uses: denoland/setup-deno@v1
        with:
          deno-version: v1.26.1
      - name: Run cache & check
        run: |
          deno task cache
      - name: Run test
        id: test
        env:
          FIREBASE_USERNAME: test@example.com
          FIREBASE_PASSWORD: server-admin
          FIREBASE_TEST: true
        working-directory: ./firebase-emulator
        run: |
          firebase emulators:exec --import ./data/ "deno task start > /dev/null & deno task test"